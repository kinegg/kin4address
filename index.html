<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.cdnfonts.com/css/latin-modern-mono" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/base32/0.0.6/base32.js"></script>
    <script src="bs58.bundle.js"></script>
    <title>KIN3 to KIN4 address converter</title>
    <style>
        body {
            margin: 50px;
            font-family: 'LMMono10';
            display: grid;
            grid-template-rows: 5;
            justify-content: center;
            width: 100%;
        }
        #result {
            display: none;
        }
    </style>
</head>

<body>

    <div>
        <img src="kin.png" width="256">
    </div>
    <p></p>
    <label for="kin3">Paste your KIN3 address here:</label><p>
    <input id="kin3" type="text" size=80 oninput="javascript:onChange()">
    <p>
    <div id="result">
        <label for="kin4">KIN4 address (click to see token holdings):</label>
        <div id="kin4">...</div>
    </div>

    <script lang="javascript">

        base32tohex = (function () {
            var dec2hex = function (s) {
                return (s < 15.5 ? "0" : "") + Math.round(s).toString(16)
            }
                , hex2dec = function (s) {
                    return parseInt(s, 16)
                }
                , base32tohex = function (base32) {
                    for (var base32chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567", bits = "", hex = "", i = 0; i < base32.length; i++) {
                        var val = base32chars.indexOf(base32.charAt(i).toUpperCase());
                        bits += leftpad(val.toString(2), 5, "0")
                    }
                    for (i = 0; i + 4 <= bits.length; i += 4) {
                        var chunk = bits.substr(i, 4);
                        hex += parseInt(chunk, 2).toString(16)
                    }
                    return hex
                }
                , leftpad = function (str, len, pad) {
                    return len + 1 >= str.length && (str = new Array(len + 1 - str.length).join(pad) + str),
                        str
                };
            return base32tohex;
        }
        )()

        const fromHexString = hexString => new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

        function toHex(s) { let r = ''; for (let i = 0; i < s.length; i++) { r += s.charCodeAt(i).toString(16); } return r; }

        function onChange() {
            const result = document.getElementById('result');
            try {
                const kin4elem = document.getElementById('kin4');
                const kin3 = document.getElementById('kin3').value;
                const decodedHex = base32tohex(kin3);
                const hex = decodedHex.substr(2, decodedHex.length - 6);
                const kin4 = bs58.encode(fromHexString(hex));
                kin4elem.innerHTML = `<a target="_blank" href="https://explorer.solana.com/address/${kin4}/tokens">${kin4}</a>`;
                result.style.display = 'block';
            }
            catch (err) {
                console.log(err)
                result.style.display = 'none';
            }
        }

        document.getElementById('kin3').focus()
    </script>
</body>

</html>